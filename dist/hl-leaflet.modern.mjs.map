{"version":3,"file":"hl-leaflet.modern.mjs","sources":["../src/hl-leaflet.ts"],"sourcesContent":["import L from \"leaflet\"\n\nconst mapCache = {} as Record<string, HlMap>\n\ntype HlMapConfig = {\n    hlRender: string,\n    hlCenter: string,\n    hlZoom: string,\n    markers: HlMarkerConfig[]\n}\n\ntype HlMarkerConfig = {\n    hlCenter?: string,\n    hlPopup?: string,\n}\n\ntype HlMap = {\n    config: HlMapConfig\n    configElement: HTMLElement,\n    renderElement: HTMLElement | null,\n    map?: L.Map,\n    configString?: string,\n}\n\nfunction els(nodes: NodeListOf<Element>): HTMLElement[] {\n    return Array.prototype.slice.call(nodes)\n}\n\nfunction findMaps(): HlMap[] {\n    const maps = els(document.body.querySelectorAll(\".hl-map\"))\n    return maps.map((map) => {\n        const dataset = map.dataset\n\n        // Basic config\n        const data: HlMapConfig = {\n            hlRender: dataset.hlRender ?? \"\",\n            hlCenter: dataset.hlCenter ?? \"[0,0]\",\n            hlZoom: dataset.hlZoom ?? \"10\",\n            markers: [] as HlMarkerConfig[]\n        }\n\n        // Detect markers\n        els(map.querySelectorAll(\".hl-marker\")).forEach((marker) => {\n            const markerData = marker.dataset as HlMarkerConfig\n            data.markers.push({\n                hlCenter: markerData.hlCenter,\n                hlPopup: markerData.hlPopup\n            })\n        })\n\n        return {\n            config: data,\n            configElement: map,\n            renderElement: document.querySelector(data.hlRender)\n        }\n    })\n}\n\n\nfunction apply(\n    map: HlMap,\n) {\n    const lMap = map.map\n    if (lMap === undefined) return\n    const center = map.config.hlCenter\n    const zoom = map.config.hlZoom\n\n    lMap.setView(JSON.parse(center), parseInt(zoom))\n\n    // Layers\n    const hasLayer = lMap.options.layers?.find((layer) =>\n        layer.options.attribution === \"© OpenStreetMap contributors\"\n    )\n    if (!hasLayer) L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\n        attribution: '© OpenStreetMap contributors'\n    }).addTo(lMap);\n\n\n    // Remove layers\n    lMap.eachLayer((layer) => {\n        if (layer instanceof L.Marker) {\n            layer.removeFrom(lMap)\n        }\n    })\n\n    // Markers\n    map.config.markers.forEach((marker) => {\n        const center = marker.hlCenter ?? map.config.hlCenter\n        const popup = marker.hlPopup ?? \"\"\n        const markerLayer = L.marker(JSON.parse(center))\n        markerLayer.setIcon(L.icon({\n            iconUrl: \"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png\",\n            iconSize: [25, 41],\n            iconAnchor: [12, 41],\n            popupAnchor: [1, -34],\n        }))\n        if (popup !== \"\") markerLayer.bindPopup(popup)\n        markerLayer.addTo(lMap)\n    })\n}\n\nfunction initMaps(maps: HlMap[]) {\n    maps.forEach((map) => {\n        const {configElement, renderElement, config} = map\n        if (renderElement === null) return\n        const lMap = L.map(renderElement)\n        map.map = lMap\n        apply(map)\n        mapCache[configElement.id] = {\n            ...map,\n            configString: JSON.stringify(config),\n        }\n\n        // Bind events\n        lMap.on(\"moveend\", () => {\n            const center = lMap.getCenter()\n            const zoom = lMap.getZoom()\n            const event = new CustomEvent(\"hl-leaflet-moveend\", {\n                detail: {\n                    center: [center.lat, center.lng],\n                    zoom: zoom\n                }\n            })\n            renderElement.dispatchEvent(event)\n        })\n\n        lMap.on(\"popupopen\", (e) => {\n            const event = new CustomEvent(\"hl-leaflet-popupopen\", {\n                detail: {\n                    popup: e.popup.getElement()\n                }\n            })\n            renderElement.dispatchEvent(event)\n        })\n    })\n}\n\nfunction updateMaps(maps: HlMap[]) {\n    maps.forEach((map) => {\n        const cached = mapCache[map.configElement.id]\n        if (cached === undefined) return\n        const {map: lMap} = cached\n        if (lMap === undefined) return\n        const configString = JSON.stringify(map.config)\n        if (configString == cached.configString) return\n        cached.config = map.config\n        cached.configString = configString\n        apply(cached)\n    })\n}\n\n\nwindow.addEventListener(\"load\", () => {\n    const maps = findMaps()\n    initMaps(maps)\n    const observer = new MutationObserver(() => updateMaps(findMaps()))\n    observer.observe(document.body, {\n        childList: true,\n        subtree: true,\n        attributes: true,\n        attributeFilter: [\n            \"data-hl-center\",\n            \"data-hl-zoom\",\n            \"data-hl-render\",\n            \"data-hl-popup\"\n        ]\n    })\n})\n\nexport default {\n    findMaps,\n    initMaps,\n    updateMaps,\n    mapCache,\n    apply\n}\n"],"names":["mapCache","els","nodes","Array","prototype","slice","call","findMaps","document","body","querySelectorAll","map","_dataset$hlRender","_dataset$hlCenter","_dataset$hlZoom","dataset","data","hlRender","hlCenter","hlZoom","markers","forEach","marker","markerData","push","hlPopup","config","configElement","renderElement","querySelector","apply","_lMap$options$layers","lMap","undefined","zoom","setView","JSON","parse","parseInt","options","layers","find","layer","attribution","L","tileLayer","addTo","eachLayer","Marker","removeFrom","_marker$hlCenter","_marker$hlPopup","center","popup","markerLayer","setIcon","icon","iconUrl","iconSize","iconAnchor","popupAnchor","bindPopup","initMaps","maps","id","_extends","configString","stringify","on","getCenter","getZoom","event","CustomEvent","detail","lat","lng","dispatchEvent","e","getElement","updateMaps","cached","window","addEventListener","MutationObserver","observe","childList","subtree","attributes","attributeFilter"],"mappings":"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"}