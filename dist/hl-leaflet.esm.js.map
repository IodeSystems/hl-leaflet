{"version":3,"file":"hl-leaflet.esm.js","sources":["../src/hl-leaflet.ts"],"sourcesContent":["import L, {LatLngTuple} from \"leaflet\"\n\nconst mapCache = {} as Record<string, HlMap>\n\ntype HlMapConfig = {\n    hlRender: string,\n    hlCenter: LatLngTuple,\n    hlZoom: number,\n    hlPreserve: boolean,\n    markers: HlMarkerConfig[]\n}\n\ntype HlMarkerConfig = {\n    hlCenter?: LatLngTuple,\n    hlPopup?: string,\n}\n\ntype HlMap = {\n    config: HlMapConfig\n    configElement: HTMLElement,\n    renderElement: HTMLElement | null,\n    map?: L.Map,\n    configString?: string,\n}\n\nexport type HlMapMoveEndEvent = {\n    center: LatLngTuple,\n    zoom: number,\n    bounds: LatLngTuple[]\n}\n\nexport type HlPopupOpenEvent = {\n    popup: HTMLElement\n}\n\nfunction moveEvent(map:L.Map) {\n    const center = map.getCenter()\n    const zoom = map.getZoom()\n    const nw = map.getBounds().getNorthWest()\n    const se = map.getBounds().getSouthEast()\n    const bounds: LatLngTuple[] = [[nw.lat, nw.lng], [se.lat, se.lng]]\n    const event: HlMapMoveEndEvent = {\n        center: [center.lat, center.lng],\n        zoom: zoom,\n        bounds: bounds\n    }\n    return new CustomEvent(\"hl-leaflet-moveend\", {\n        detail: event\n    })\n}\n\nfunction els(nodes: NodeListOf<Element>): HTMLElement[] {\n    return Array.prototype.slice.call(nodes)\n}\n\nfunction findMaps(): HlMap[] {\n    const maps = els(document.body.querySelectorAll(\".hl-map\"))\n    return maps.map((map) => {\n        const dataset = map.dataset\n\n        // Basic config\n        const data: HlMapConfig = {\n            hlRender: dataset.hlRender ?? \"\",\n            hlCenter: JSON.parse(dataset.hlCenter ?? \"[0,0]\"),\n            hlZoom: JSON.parse(dataset.hlZoom ?? \"10\"),\n            hlPreserve: JSON.parse(dataset.hlPreserve ?? \"false\"),\n            markers: [] as HlMarkerConfig[]\n        }\n\n        // Detect markers\n        els(map.querySelectorAll(\".hl-marker\")).forEach((marker) => {\n            const markerData = marker.dataset\n            data.markers.push({\n                hlCenter: JSON.parse(markerData.hlCenter ?? \"[0,0]\"),\n                hlPopup: markerData.hlPopup\n            })\n        })\n\n        return {\n            config: data,\n            configElement: map,\n            renderElement: document.querySelector(data.hlRender)\n        }\n    })\n}\n\n\nfunction apply(\n    map: HlMap,\n) {\n    const lMap = map.map\n    if (lMap === undefined) return\n    const center = map.config.hlCenter\n    const zoom = map.config.hlZoom\n\n    lMap.setView(center, zoom)\n\n    // Layers\n    const hasLayer = lMap.options.layers?.find((layer) =>\n        layer.options.attribution === \"© OpenStreetMap contributors\"\n    )\n    if (!hasLayer) L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\n        attribution: '© OpenStreetMap contributors'\n    }).addTo(lMap);\n\n\n    // Remove layers\n    lMap.eachLayer((layer) => {\n        if (layer instanceof L.Marker) {\n            layer.removeFrom(lMap)\n        }\n    })\n\n    // Markers\n    map.config.markers.forEach((marker) => {\n        const center = marker.hlCenter ?? map.config.hlCenter\n        const popup = marker.hlPopup ?? \"\"\n        const markerLayer = L.marker(center)\n        markerLayer.setIcon(L.icon({\n            iconUrl: \"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png\",\n            iconSize: [25, 41],\n            iconAnchor: [12, 41],\n            popupAnchor: [1, -34],\n        }))\n        if (popup !== \"\") markerLayer.bindPopup(popup)\n        markerLayer.addTo(lMap)\n    })\n}\n\nfunction initMaps(maps: HlMap[]) {\n    maps.forEach((map) => {\n        const {configElement, renderElement, config} = map\n        if (renderElement === null) return\n        const lMap = L.map(renderElement)\n        map.map = lMap\n        apply(map)\n        mapCache[configElement.id] = {\n            ...map,\n            configString: JSON.stringify(config),\n        }\n\n        // Bind events\n        lMap.on(\"moveend\", () => {\n            renderElement.dispatchEvent(moveEvent(lMap))\n        })\n\n        lMap.on(\"popupopen\", (e) => {\n            const popupEvent: HlPopupOpenEvent = {\n                popup: e.popup.getElement()!!\n            }\n            const event = new CustomEvent(\"hl-leaflet-popupopen\", {\n                detail: popupEvent\n            })\n            renderElement.dispatchEvent(event)\n        })\n\n        // Fire initial moveend event\n        renderElement.dispatchEvent(moveEvent(lMap))\n    })\n}\n\nfunction updateMaps(maps: HlMap[]) {\n    maps.forEach((map) => {\n        const cached = mapCache[map.configElement.id]\n        if (cached === undefined) return\n        const {map: lMap} = cached\n        if (lMap === undefined) return\n        const configString = JSON.stringify(map.config)\n        if (configString == cached.configString) return\n        cached.config = map.config\n        cached.configString = configString\n        apply(cached)\n    })\n}\n\n\nwindow.addEventListener(\"load\", () => {\n    const maps = findMaps()\n    initMaps(maps)\n    const observer = new MutationObserver(() => updateMaps(findMaps()))\n    observer.observe(document.body, {\n        subtree: true,\n        // Mutation observer does not fire on new attributes! The only way to detect\n        // new attributes is to observe the whole childList.\n        childList: true,\n        // We only care about these attributes currently\n        attributes: true,\n        attributeFilter: [\n            \"data-hl-center\",\n            \"data-hl-zoom\",\n            \"data-hl-render\",\n            \"data-hl-popup\"\n        ]\n    })\n})\n\n/**\n * Synchronize a maps center, zoom and bounds with the given values\n */\nfunction syncMove(element: HTMLElement, event: HlMapMoveEndEvent) {\n    // Update the element\n    element.setAttribute(\"data-hl-center\", JSON.stringify(event.center))\n    element.setAttribute(\"data-hl-zoom\", JSON.stringify(event.zoom))\n    element.setAttribute(\"data-hl-bounds\", JSON.stringify(event.bounds))\n    // Update the cache\n    const cache = mapCache[element.id]\n    if (cache === undefined) return\n    cache.config = {\n        ...cache.config,\n        hlCenter: event.center,\n        hlZoom: event.zoom\n    }\n    cache.configString = JSON.stringify(cache.config)\n}\n\nexport default {\n    findMaps,\n    initMaps,\n    updateMaps,\n    mapCache,\n    apply,\n    syncMove\n}\n"],"names":["mapCache","moveEvent","map","center","getCenter","zoom","getZoom","nw","getBounds","getNorthWest","se","getSouthEast","CustomEvent","detail","lat","lng","bounds","els","nodes","Array","prototype","slice","call","findMaps","document","body","querySelectorAll","_dataset$hlRender","_dataset$hlCenter","_dataset$hlZoom","_dataset$hlPreserve","dataset","data","hlRender","hlCenter","JSON","parse","hlZoom","hlPreserve","markers","forEach","marker","_markerData$hlCenter","markerData","push","hlPopup","config","configElement","renderElement","querySelector","apply","_lMap$options$layers","lMap","undefined","setView","options","layers","find","layer","attribution","L","tileLayer","addTo","eachLayer","Marker","removeFrom","_marker$hlCenter","_marker$hlPopup","popup","markerLayer","setIcon","icon","iconUrl","iconSize","iconAnchor","popupAnchor","bindPopup","initMaps","maps","id","_extends","configString","stringify","on","dispatchEvent","e","popupEvent","getElement","event","updateMaps","cached","window","addEventListener","MutationObserver","observe","subtree","childList","attributes","attributeFilter","hlLeaflet","syncMove","element","setAttribute","cache"],"mappings":"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"}